generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(uuid())
  email               String              @unique
  pseudo              String              @unique
  password            String // Hashed password
  firstName           String?
  lastName            String?
  role                Role
  profileUrl          String?
  coachId             String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  createdExercises    Exercise[]
  groupMemberships    GroupMember[]
  ownedGroups         Group[]
  sentInvitations     Invitation[]        @relation("SentInvitations")
  receivedInvitations Invitation[]        @relation("ReceivedInvitations")
  notifications       Notification[]
  assignedBy          ProgramAssignment[] @relation("CoachAssignments")
  assignedPrograms    ProgramAssignment[] @relation("StudentAssignments")
  auditLogs           ProgramAudit[]
  createdPrograms     Program[]
  sessionProgress     SessionProgress[]
  badges              UserBadge[]
  exerciseRatings     ExerciseRating[]
  exerciseHistory     ExerciseHistory[]
  favoriteExercises   FavoriteExercise[]
  workoutSessions     WorkoutSession[]
  coach               User?               @relation("CoachStudents", fields: [coachId], references: [id])
  students            User[]              @relation("CoachStudents")

  @@map("users")
}

model Group {
  id          String        @id @default(uuid())
  ownerId     String
  name        String
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  members     GroupMember[]
  owner       User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  invitations Invitation[]

  @@map("groups")
}

model GroupMember {
  id          String   @id @default(uuid())
  groupId     String
  userId      String
  roleInGroup String   @default("member")
  joinedAt    DateTime @default(now())
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model Invitation {
  id          String           @id @default(uuid())
  groupId     String
  fromCoachId String
  toUserId    String
  status      InvitationStatus
  createdAt   DateTime         @default(now())
  respondedAt DateTime?
  fromCoach   User             @relation("SentInvitations", fields: [fromCoachId], references: [id])
  group       Group            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  toUser      User             @relation("ReceivedInvitations", fields: [toUserId], references: [id])

  @@unique([groupId, toUserId, status])
  @@map("invitations")
}

model Exercise {
  id               String             @id @default(uuid())
  name             String
  description      String?
  type             ExerciseType
  meta             Json?
  scope            Scope
  ownerId          String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  owner            User?              @relation(fields: [ownerId], references: [id])
  sessionExercises SessionExercise[]
  ratings          ExerciseRating[]
  history          ExerciseHistory[]
  favorites        FavoriteExercise[]
  logs             ExerciseLog[]

  @@map("exercises")
}

model ExerciseRating {
  id         String   @id @default(uuid())
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  rating     Int      @db.SmallInt
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([exerciseId, userId])
  @@index([exerciseId])
  @@index([userId])
  @@map("exercise_ratings")
}

model ExerciseHistory {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId String
  viewedAt   DateTime @default(now())

  @@index([userId])
  @@index([exerciseId])
  @@index([viewedAt])
  @@map("exercise_history")
}

model FavoriteExercise {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId String
  addedAt    DateTime @default(now())

  @@unique([userId, exerciseId])
  @@index([userId])
  @@index([exerciseId])
  @@map("favorite_exercises")
}

model WorkoutSession {
  id                  String        @id @default(uuid())
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String
  title               String?
  startedAt           DateTime      @default(now())
  startTime           DateTime? // Alternative field for compatibility
  endedAt             DateTime?
  endTime             DateTime? // Alternative field for compatibility
  duration            Int? // in seconds
  notes               String?
  restPeriodSeconds   Int?          @default(60)
  formGuidanceEnabled Boolean?      @default(true)
  exercisesCompleted  Int?          @default(0)
  totalExercises      Int?          @default(0)
  logs                ExerciseLog[]

  @@index([userId])
  @@index([startedAt])
  @@map("workout_sessions")
}

model ExerciseLog {
  id            String         @id @default(uuid())
  session       WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sessionId     String
  exercise      Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId    String
  userId        String? // For filtering by user
  reps          Int?
  sets          Int?
  setsCompleted Int?
  weight        Float?
  duration      Int? // in seconds
  formRating    Int? // 1-5 scale
  skipped       Boolean?       @default(false)
  notes         String?
  loggedAt      DateTime       @default(now())
  completedAt   DateTime?

  @@index([sessionId])
  @@index([exerciseId])
  @@map("exercise_logs")
}

model Program {
  id          String              @id @default(uuid())
  title       String
  description String?
  coachId     String
  ownerId     String? // For program owner (for cloning)
  isDraft     Boolean             @default(true)
  data        Json? // For storing complex program data
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  assignments ProgramAssignment[]
  auditLogs   ProgramAudit[]
  blocks      ProgramBlock[]
  coach       User                @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@map("programs")
}

model ProgramBlock {
  id        String  @id @default(uuid())
  programId String
  title     String?
  position  Int
  notes     String?
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  weeks     Week[]

  @@map("program_blocks")
}

model Week {
  id         String       @id @default(uuid())
  blockId    String
  weekNumber Int
  position   Int
  sessions   Session[]
  block      ProgramBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@map("weeks")
}

model Session {
  id        String            @id @default(uuid())
  weekId    String
  title     String?
  notes     String?
  date      DateTime?
  position  Int
  data      Json? // For storing session data
  exercises SessionExercise[]
  progress  SessionProgress[]
  week      Week              @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model SessionExercise {
  id                String            @id @default(uuid())
  sessionId         String
  exerciseId        String
  config            Json?
  position          Int
  exercise          Exercise          @relation(fields: [exerciseId], references: [id])
  session           Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  progressInstances SessionProgress[]

  @@map("session_exercises")
}

model SessionProgress {
  id                 String           @id @default(uuid())
  sessionId          String
  studentId          String
  exerciseInstanceId String?
  progress           Json?
  notes              String?
  videos             String[]
  savedAt            DateTime         @default(now())
  exerciseInstance   SessionExercise? @relation(fields: [exerciseInstanceId], references: [id])
  session            Session          @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student            User             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("session_progress")
}

model ProgramAssignment {
  id         String   @id @default(uuid())
  programId  String
  studentId  String
  assignedBy String?
  assignedAt DateTime @default(now())
  assigner   User?    @relation("CoachAssignments", fields: [assignedBy], references: [id])
  program    Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  student    User     @relation("StudentAssignments", fields: [studentId], references: [id], onDelete: Cascade)

  @@map("program_assignments")
}

model ProgramAudit {
  id         String   @id @default(uuid())
  programId  String
  changedBy  String
  changeType String
  diff       Json?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [changedBy], references: [id])
  program    Program  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@map("program_audit")
}

model Badge {
  id          String      @id @default(uuid())
  key         String      @unique
  title       Json
  description Json
  criteria    Json
  userBadges  UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  badge     Badge    @relation(fields: [badgeId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("user_badges")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  payload   Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

enum Role {
  admin
  coach
  student
}

enum ExerciseType {
  standard
  EMOM
  AMRAP
  custom
}

enum Scope {
  global
  coach
}

enum InvitationStatus {
  pending
  accepted
  rejected
}
